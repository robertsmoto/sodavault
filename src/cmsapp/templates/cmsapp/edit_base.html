{% extends 'common/base.html' %}
{% load django_bootstrap5 %}
{% load static %}

{% block css_styling %}
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet" />
<link 
  rel="stylesheet" 
  href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
{% endblock %}
{% block content %}
<div class="mt-3">
  <a 
    class="btn btn-light" 
    data-bs-toggle="collapse" 
    href="#docFields" 
    role="button">Document</a>
{% block section_buttons %}{% endblock %}
</div>
<form 
  action="{% url 'manage_document' docType docID %}"
  method="{% block form_method %}POST{% endblock %}" 
  id="form-{{docType}}">

  {% csrf_token %}

  <!-- begin doc section -->
  <div 
    class="row collapse multi-collapse b-3 m-3" 
    id="docFields">
    <div 
      id="docBanner" 
      class="col-12 p-2 alert alert-light rounded border">Document
    </div>
    <!-- begin doc fields -->
    <div class='row'>

      {% with form_document as form %}
      <div class="col-12 col-md-4 mt-2">
          {{ form.type.errors }}
          {{ form.type.label_tag }}
          {{ form.type }}
          <p 
            id="docSetHelp" 
            class="form-text">{{ doc.type.help_text|safe }}</p>
      </div>
      <div class="col-12 col-md-4 mt-2">
          {{ form.ID.errors }}
          {{ form.ID.label_tag }}
          {{ form.ID }}
          <p 
            id="formIDHelp" 
            class="form-text">{{ form.ID.help_text|safe }}</p>
      </div>
      <div class="col-12 col-md-4 mt-2">
          {{ form.parentID.errors }}
          {{ form.parentID.label_tag }}
          {{ form.parentID }}
          <div 
            id="formParentIDHelp" 
            class="form-text">{{ form.parentID.help_text|safe }}</div>
      </div>
      <div class="col-12 col-md-6 mt-2">
          {{ form.title.errors }}
          {{ form.title.label_tag }}
          {{ form.title }}
          <div 
            id="formTitleHelp" 
            class="form-text">{{ form.title.help_text|safe }}</div>
      </div>
      <div class="col-12 col-md-6 mt-2">
          {{ form.lexi.errors }}
          {{ form.lexi.label_tag }}
          {{ form.lexi }}
          <div 
            id="formLexiHelp" 
            class="form-text">{{ form.lexi.help_text|safe }}</div>
      </div>
      <div class="col-12 col-md-6 mt-2">
          {{ form.description.errors }}
          {{ form.description.label_tag }}
          {{ form.description }}
          <div 
            id="formDescriptionHelp" 
            class="form-text">{{ form.description.help_text|safe }}</div>
      </div>
      <div class="col-12 col-md-6 mt-2">
          {{ form.index.errors }}
          {{ form.index.label_tag }}
          {{ form.index }}
          <div 
            id="formIndexHelp" 
            class="form-text">{{ form.index.help_text|safe }}</div>
      </div>
      <div class="col-12 col-md-6 mt-2">
          {{ form.createdAt.errors }}
          {{ form.createdAt.label_tag }}
          {{ form.createdAt }}
          <div 
            id="formCreatedAtHelp" 
            class="form-text">{{ form.createdAt.help_text|safe }}</div>
      </div>
      <div class="col-12 col-md-6 mt-2">
          {{ form.updatedAt.errors }}
          {{ form.updatedAt.label_tag }}
          {{ form.updatedAt }}
          <div 
            id="docUpdatedAtHelp" 
            class="form-text">{{ form.updatedAt.help_text|safe }}</div>
      </div>
      {% endwith %}

    </div>
  </div>
  <!-- end doc fields -->
  {% block form_sections %}{% endblock %}

  <!-- end form fields -->
  <button 
    type="submit" 
    class="btn btn-{% block btn_color %}primary{% endblock %} mt-3">
    {% block btn_value %}Submit{% endblock %}</button>
  <a 
    type="button" 
    class="btn btn-light mt-3" 
    href="{% block cancel_url %}
    {% url 'document_list' docType %}
    {% endblock %}">Cancel</a>

  {% if debug %}
  <p class="mt-3">Form.initial -- debug</p>
  <pre>{{ form.initial|pprint }}</pre>
  {% endif %}

</form>
{% endblock %}

{% block bottomscripts %}
{{ form_document.initial|json_script:"form-data" }}
<script>
const DOC = JSON.parse(document.getElementById('form-data').textContent);
</script>
<script 
  type="text/javascript" src="{% static 'js/select2.min.js' %}"></script>
<script 
  type="text/javascript" src="{% static 'js/document.functions.js' %}"></script>
<script 
  type="text/javascript" src="{% static 'js/ui.base.js' %}"></script>
<script>

lexiInput("#id_title")

$( document ).ready(function() {
  $("#docFields").collapse("show");
  });

function select2_choices(callback, args) {
  $.ajax({
    async: true,
    dataType: "json",
    url: args.url,
    data: { 
        docType: args.docType,
        sortBy: args.sortBy,
        choiceID: args.choiceID,
        choiceHuman: args.choiceHuman,
        removeID: args.removeID,
        selectedIDs: args.selectedIDs
      },
    success: function (response) {
        callback(response);
    }
  });
};

select2_choices(function (data) {
  // handle response data here
  $("#id_parentID").select2({
    allowClear: true,
    data: data.results,
    placeholder: 'choose ...',
    theme: 'bootstrap-5',
    width: "100%",
  });
  },{ 
      url: "/cms/get/select/choices", 
      docType: DOC.type, 
      sortBy: "docLexi:ASC", 
      choiceID: "ID", 
      choiceHuman: "title", 
      removeID: DOC.ID, 
      selectedIDs: DOC.parentID
    }
  );

</script>
{% endblock %}
